{% extends 'base.html' %}
{% block title %}Obokförda Fakturor - {{ company.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="h2 mb-0 fw-bold text-primary">
                    <i class="bi bi-file-earmark-text me-2"></i>
                    Obokförda Fakturor: {{ company.name }}
                </h2>
                <div>
                    <a href="{{ url_for('main.sync_invoices', company_id=company.id) }}" class="btn btn-primary btn-lg">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        Synkronisera Fakturor
                    </a>
                    <a href="{{ url_for('main.ai_settings_page') }}" class="btn btn-outline-info btn-lg">
                        <i class="bi bi-robot me-1"></i>
                        AI-inställningar
                    </a>
                </div>
            </div>
             <p class="text-muted mt-2">Här visas fakturor som ännu inte har bokförts. Du kan bokföra dem manuellt eller använda AI för att få förslag.</p>
        </div>
    </div>

    <!-- Invoices Section -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <h3 class="h4 mb-0 fw-semibold text-muted">
                        <i class="bi bi-list-ul me-2"></i>
                        Obearbetade Fakturor
                    </h3>
                    <div class="d-flex gap-2">
                        <button id="batch-book-btn" class="btn btn-success btn-lg px-4" disabled>
                            <i class="bi bi-check-circle me-1"></i>
                            Bokför markerade med AI (<span id="selected-count">0</span>)
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0 align-middle sortable-table">
                            <thead class="table-dark">
                                <tr>
                                    <th scope="col" class="text-center" style="width: 50px;">
                                        <input type="checkbox" id="select-all-checkbox" class="form-check-input">
                                    </th>
                                    <th scope="col" class="sortable" data-sort="date">
                                        <span>Fakturadatum</span>
                                        <i class="bi bi-arrow-up-down ms-1"></i>
                                    </th>
                                    <th scope="col" class="sortable" data-sort="number">
                                        <span>Fakturanr</span>
                                        <i class="bi bi-arrow-up-down ms-1"></i>
                                    </th>
                                    <th scope="col" class="sortable" data-sort="client">
                                        <span>Kund</span>
                                        <i class="bi bi-arrow-up-down ms-1"></i>
                                    </th>
                                    <th scope="col" class="text-end sortable" data-sort="sum">
                                        <span>Belopp</span>
                                        <i class="bi bi-arrow-up-down ms-1"></i>
                                    </th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Moms-Status</th>
                                    <th scope="col" class="text-end" style="width: 120px;">Åtgärd</th>
                                </tr>
                            </thead>
                            <tbody id="invoices-table-body">
                                {% for invoice in invoices %}
                                    <tr id="invoice-row-{{ invoice.id }}" class="invoice-row" data-invoice-id="{{ invoice.id }}" style="cursor: pointer;"
                                        data-date="{{ invoice.date.strftime('%Y-%m-%d') if invoice.date else '' }}"
                                        data-number="{{ invoice.number }}"
                                        data-client="{{ invoice.client.name if invoice.client else 'N/A' }}"
                                        data-sum="{{ invoice.sum }}"
                                        data-reverse-charge="{{ 'true' if invoice.reverse_charge else 'false' }}">
                                        <td class="text-center">
                                            <input type="checkbox" class="form-check-input invoice-checkbox" data-invoice-id="{{ invoice.id }}">
                                        </td>
                                        <td class="fw-medium">{{ invoice.date.strftime('%Y-%m-%d') if invoice.date else 'N/A' }}</td>
                                        <td>{{ invoice.number }}</td>
                                        <td>{{ invoice.client.name if invoice.client else 'N/A' }}</td>
                                        <td class="text-end fw-bold text-success">{{ "%.2f"|format(invoice.sum) }} kr</td>
                                        <td>
                                            {% if invoice.status == 'betald' %}<span class="badge bg-success px-2 py-1 fs-6">Betald</span>
                                            {% elif invoice.status == 'skickad' %}<span class="badge bg-warning text-dark px-2 py-1 fs-6">Skickad</span>
                                            {% else %}<span class="badge bg-secondary px-2 py-1 fs-6">{{ invoice.status | capitalize }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if invoice.reverse_charge %}
                                                <span class="badge bg-info text-dark px-2 py-1 fs-6">Omvänd</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            <button class="btn btn-outline-primary btn-sm ask-ai-btn px-3" data-invoice-id="{{ invoice.id }}" title="Få bokföringsförslag">
                                                <i class="bi bi-robot me-1"></i>
                                                AI
                                            </button>
                                        </td>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td colspan="8" class="text-center py-5">
                                            <i class="bi bi-check-circle-fill text-success fs-1"></i>
                                            <h4 class="mt-3">Bra jobbat!</h4>
                                            <p class="text-muted">Det finns inga obokförda fakturor.</p>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% include '_generic_entry_modal.html' %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const companyId = {{ company.id }};
    const kontoplan = {{ KONTOPLAN|tojson }};
    const accountingMethod = "{{ company.accounting_method }}"; // 'faktura' or 'kontant'
    const genericEntryModal = new bootstrap.Modal(document.getElementById('genericEntryModal'));
    const modalForm = document.getElementById('genericEntryForm');
    const entriesContainer = document.getElementById('entries-container');
    const tableBody = document.getElementById('invoices-table-body');
    const modalLabel = document.getElementById('genericEntryModalLabel');

    // --- Table Sorting Logic (omitted for brevity) ---

    // --- Unified Modal Logic ---
    function createEntryRow(entry = {}) {
        const row = document.createElement('div');
        row.className = 'row g-2 mb-2 entry-row';
        row.innerHTML = `
            <div class="col-md-5"><select class="form-select konto-select" name="konto">${Object.entries(kontoplan).map(([nr, desc]) => `<option value="${nr}" ${entry.konto == nr ? 'selected' : ''}>${nr} - ${desc}</option>`).join('')}</select></div>
            <div class="col-md-3"><input type="number" class="form-control debet-input" name="debet" placeholder="Debet" value="${entry.debet || ''}" step="0.01"></div>
            <div class="col-md-3"><input type="number" class="form-control kredit-input" name="kredit" placeholder="Kredit" value="${entry.kredit || ''}" step="0.01"></div>
            <div class="col-md-1"><button type="button" class="btn btn-sm btn-outline-danger remove-entry-row"><i class="bi bi-trash"></i></button></div>
        `;
        entriesContainer.appendChild(row);
        new TomSelect(row.querySelector('.konto-select'), { create: false, sortField: { field: "text", direction: "asc" } });
    }

    function updateTotals() {
        let totalDebet = 0, totalKredit = 0;
        entriesContainer.querySelectorAll('.entry-row').forEach(row => {
            totalDebet += parseFloat(row.querySelector('.debet-input').value) || 0;
            totalKredit += parseFloat(row.querySelector('.kredit-input').value) || 0;
        });
        document.getElementById('total-debet').textContent = totalDebet.toFixed(2);
        document.getElementById('total-kredit').textContent = totalKredit.toFixed(2);
        const balance = totalDebet - totalKredit;
        const balanceEl = document.getElementById('balance');
        balanceEl.textContent = balance.toFixed(2);
        balanceEl.classList.toggle('text-danger', balance.toFixed(2) != '0.00');
        balanceEl.classList.toggle('text-success', balance.toFixed(2) == '0.00');
    }

    async function populateAndShowModal(invoiceId, suggestion = null) {
        // Reset and basic setup
        modalForm.reset();
        document.getElementById('modal-entry-id').value = '';
        document.getElementById('modal-entry-type').value = 'invoice';
        document.getElementById('modal-invoice-ids').value = invoiceId;
        document.getElementById('modal-attachment-ids').value = '';
        document.getElementById('delete-entry-btn-modal').style.display = 'none';

        // Hide irrelevant sections for this view
        document.getElementById('modal-bank-event-info').style.display = 'none';
        document.getElementById('modal-underlag-section').style.display = 'none';

        // Fetch invoice details
        const response = await fetch(`/api/invoice/${invoiceId}/details`);
        const invoiceData = await response.json();

        // Populate modal header and main form fields
        modalLabel.textContent = `Bokför Faktura ${invoiceData.number}`;
        document.getElementById('modal-bokforingsdag').value = invoiceData.paid_at || invoiceData.date;
        document.getElementById('modal-referens').value = `Faktura ${invoiceData.number}`;

        // Populate right-hand column with invoice details
        const invoiceInfoSection = document.getElementById('modal-invoice-info');
        document.getElementById('invoice-info-number').textContent = invoiceData.number;
        document.getElementById('invoice-info-date').textContent = invoiceData.date || 'N/A';
        document.getElementById('invoice-info-paid-at').textContent = invoiceData.paid_at || 'Ej betald';
        document.getElementById('invoice-info-sum').textContent = parseFloat(invoiceData.sum).toFixed(2);
        document.getElementById('invoice-info-tax').textContent = parseFloat(invoiceData.tax).toFixed(2);
        document.getElementById('invoice-info-net').textContent = parseFloat(invoiceData.net).toFixed(2);
        invoiceInfoSection.style.display = 'block';
        
        const markPaidBtn = document.getElementById('mark-paid-btn');
        markPaidBtn.dataset.invoiceId = invoiceId;
        markPaidBtn.style.display = invoiceData.paid_at ? 'none' : 'block';

        // Populate underlag list
        const underlagList = document.getElementById('underlag-list');
        underlagList.innerHTML = `<li class="list-group-item">Faktura <a href="/api/invoice/${invoiceId}/pdf" target="_blank">${invoiceData.number}</a></li>`;

        // Populate bookkeeping entries
        entriesContainer.innerHTML = '';
        let entries = suggestion ? suggestion.entries : [];

        if (entries.length === 0) {
            // Default suggestion based on accounting method
            if (accountingMethod === 'faktura') {
                createEntryRow({ konto: '1510', debet: invoiceData.sum }); // Kundfordringar
                createEntryRow({ konto: '2611', kredit: invoiceData.tax }); // Utgående moms
                createEntryRow({ konto: '3001', kredit: invoiceData.net }); // Försäljning
            } else { // kontant
                createEntryRow({ konto: '1930', debet: invoiceData.sum }); // Företagskonto
                createEntryRow({ konto: '2611', kredit: invoiceData.tax }); // Utgående moms
                createEntryRow({ konto: '3001', kredit: invoiceData.net }); // Försäljning
            }
        } else {
            entries.forEach(entry => createEntryRow(entry));
        }
        
        updateTotals();
        genericEntryModal.show();
    }

    // --- Event Listeners ---
    document.getElementById('add-entry-row').addEventListener('click', () => createEntryRow());
    entriesContainer.addEventListener('click', e => {
        if (e.target.closest('.remove-entry-row')) {
            e.target.closest('.entry-row').remove();
            updateTotals();
        }
    });
    entriesContainer.addEventListener('input', e => {
        if (e.target.classList.contains('debet-input') || e.target.classList.contains('kredit-input')) {
            updateTotals();
        }
    });

    tableBody.addEventListener('click', async function(e) {
        const row = e.target.closest('.invoice-row');
        if (row && !e.target.closest('.invoice-checkbox') && !e.target.closest('.ask-ai-btn')) {
            const invoiceId = row.dataset.invoiceId;
            await populateAndShowModal(invoiceId);
        }
    });
    
    document.getElementById('mark-paid-btn').addEventListener('click', async function(e) {
        const button = e.target;
        const invoiceId = button.dataset.invoiceId;
        if (!invoiceId || !confirm('Är du säker på att du vill markera denna faktura som betald?')) return;

        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        try {
            const response = await fetch(`/api/invoice/${invoiceId}/mark_paid`, { method: 'POST' });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Okänt fel');
            
            document.getElementById('invoice-info-paid-at').textContent = new Date().toISOString().slice(0, 10);
            button.style.display = 'none';
            
            const row = document.getElementById(`invoice-row-${invoiceId}`);
            if (row) {
                const statusCell = row.querySelector('td:nth-child(6)');
                statusCell.innerHTML = '<span class="badge bg-success px-2 py-1 fs-6">Betald</span>';
            }
            
            alert('Fakturan har markerats som betald!');

        } catch (error) {
            alert(`Kunde inte uppdatera fakturan: ${error.message}`);
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-check-circle"></i> Markera som betald';
        }
    });

    modalForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const url = `/api/company/${companyId}/verifikation`;
        const method = 'POST';

        const data = {
            bokforingsdag: document.getElementById('modal-bokforingsdag').value,
            referens: document.getElementById('modal-referens').value,
            invoice_ids: document.getElementById('modal-invoice-ids').value.split(',').filter(id => id),
            attachment_ids: [], // No attachments from this page
            entries: []
        };

        entriesContainer.querySelectorAll('.entry-row').forEach(row => {
            const konto = row.querySelector('.konto-select').value;
            const debet = parseFloat(row.querySelector('.debet-input').value) || 0;
            const kredit = parseFloat(row.querySelector('.kredit-input').value) || 0;
            if (konto && (debet > 0 || kredit > 0)) {
                data.entries.push({ konto, debet, kredit });
            }
        });

        if (Math.abs(parseFloat(document.getElementById('balance').textContent)) > 0.01) {
            alert('Fel: Debet och Kredit måste vara i balans.');
            return;
        }
        if (data.entries.length < 2) {
            alert('Fel: Du måste ha minst två bokföringsposter.');
            return;
        }

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Ett fel inträffade.');

            genericEntryModal.hide();
            alert('Fakturan har bokförts!');
            location.reload();
        } catch (error) {
            alert(`Kunde inte bokföra fakturan: ${error.message}`);
        }
    });

    tableBody.addEventListener('click', async function(e) {
        const aiButton = e.target.closest('.ask-ai-btn');
        if (aiButton) {
            e.stopPropagation();
            const invoiceId = aiButton.dataset.invoiceId;
            aiButton.disabled = true;
            aiButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Laddar...';

            try {
                const response = await fetch(`/api/invoice/${invoiceId}/ask_gemini`, { method: 'POST' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Okänt AI-fel');
                
                await populateAndShowModal(invoiceId, result.suggestion);

            } catch (error) {
                alert(`AI-fel: ${error.message}`);
            } finally {
                aiButton.disabled = false;
                aiButton.innerHTML = '<i class="bi bi-robot me-1"></i>AI';
            }
        }
    });

    // --- Batch Booking Logic (omitted for brevity) ---
});
</script>
{% endblock %}
