{% extends 'base.html' %}
{% block title %}Obokförda Fakturor - {{ company.name }}{% endblock %}
{% block page_title %}Obokförda Fakturor{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-arrow-clockwise me-2"></i>Synkronisera Fakturor</h5>
            </div>
            <div class="card-body text-center">
                 <p class="text-muted">Hämta de senaste fakturorna från ditt externa faktureringssystem.</p>
                <a href="{{ url_for('main.sync_invoices', company_id=company.id) }}" class="btn btn-primary">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    Synkronisera nu
                </a>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0"><i class="bi bi-list-ul me-2"></i>Väntar på bokföring</h4>
        <button id="batch-book-btn" class="btn btn-success" disabled>
            <i class="bi bi-check-circle me-1"></i>Bokför markerade (<span id="selected-count">0</span>)
        </button>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0 sortable-table">
                <thead>
                    <tr>
                        <th scope="col" class="text-center" style="width: 50px;">
                            <input type="checkbox" id="select-all-checkbox" class="form-check-input">
                        </th>
                        <th scope="col" class="sortable" data-sort="date">Fakturadatum <i class="bi bi-arrow-up-down ms-1"></i></th>
                        <th scope="col" class="sortable" data-sort="number">Fakturanr <i class="bi bi-arrow-up-down ms-1"></i></th>
                        <th scope="col" class="sortable" data-sort="client">Kund <i class="bi bi-arrow-up-down ms-1"></i></th>
                        <th scope="col" class="text-end sortable" data-sort="amount">Belopp <i class="bi bi-arrow-up-down ms-1"></i></th>
                        <th scope="col">Status</th>
                        <th scope="col" class="text-center">Omvänd Skatt</th>
                        <th scope="col" class="text-end">Åtgärd</th>
                    </tr>
                </thead>
                <tbody id="invoices-table-body">
                    {% for invoice in invoices %}
                        <tr id="invoice-row-{{ invoice.id }}" class="invoice-row" data-invoice-id="{{ invoice.id }}" style="cursor: pointer;"
                            data-date="{{ invoice.date.strftime('%Y-%m-%d') if invoice.date else '' }}"
                            data-number="{{ invoice.number }}"
                            data-client="{{ invoice.client.name if invoice.client else '' }}"
                            data-amount="{{ invoice.sum }}">
                            <td class="text-center">
                                <input type="checkbox" class="form-check-input invoice-checkbox" data-invoice-id="{{ invoice.id }}">
                            </td>
                            <td class="fw-medium">{{ invoice.date.strftime('%Y-%m-%d') if invoice.date else 'N/A' }}</td>
                            <td>{{ invoice.number }}</td>
                            <td>{{ invoice.client.name if invoice.client else 'N/A' }}</td>
                            <td class="text-end fw-bold text-success">{{ "%.2f"|format(invoice.sum) }} kr</td>
                            <td>
                                {% if invoice.status == 'betald' %}<span class="badge bg-success">Betald</span>
                                {% elif invoice.status == 'skickad' %}<span class="badge bg-warning text-dark">Skickad</span>
                                {% else %}<span class="badge bg-secondary">{{ invoice.status | capitalize }}</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div class="form-check form-switch d-inline-block">
                                    <input class="form-check-input reverse-charge-switch" type="checkbox" role="switch" id="reverse-charge-{{ invoice.id }}" data-invoice-id="{{ invoice.id }}" {% if invoice.reverse_charge %}checked{% endif %}>
                                </div>
                            </td>
                            <td class="text-end">
                                <button class="btn btn-outline-primary btn-sm ask-ai-btn-table" data-invoice-id="{{ invoice.id }}" title="Få bokföringsförslag">
                                    <i class="bi bi-robot me-1"></i>AI
                                </button>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center py-4 text-muted">
                                Inga obokförda fakturor hittades.
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% include '_generic_entry_modal.html' %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/tableSorter.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    new TableSorter('sortable-table'); // Initialize table sorter

    // --- Variabler och konstanter ---
    const companyId = {{ company.id }};
    const kontoplan = {{ KONTOPLAN|tojson }};
    const accountingMethod = "{{ company.accounting_method }}";
    const genericEntryModal = new bootstrap.Modal(document.getElementById('genericEntryModal'));
    const modalForm = document.getElementById('genericEntryForm');
    const entriesContainer = document.getElementById('entries-container');
    const tableBody = document.getElementById('invoices-table-body');
    const modalLabel = document.getElementById('genericEntryModalLabel');
    const askAiBtnModal = document.getElementById('ask-ai-btn-modal');

    // --- Modal-logik ---

    function createEntryRow(entry = {}) {
        const row = document.createElement('div');
        row.className = 'row g-2 mb-2 entry-row';
        row.innerHTML = `
            <div class="col-md-5"><select class="form-select konto-select" name="konto">${Object.entries(kontoplan).map(([nr, desc]) => `<option value="${nr}" ${entry.account == nr ? 'selected' : ''}>${nr} - ${desc}</option>`).join('')}</select></div>
            <div class="col-md-3"><input type="number" class="form-control debet-input" name="debet" placeholder="Debet" value="${entry.debit || ''}" step="0.01"></div>
            <div class="col-md-3"><input type="number" class="form-control kredit-input" name="kredit" placeholder="Kredit" value="${entry.credit || ''}" step="0.01"></div>
            <div class="col-md-1"><button type="button" class="btn btn-sm btn-outline-danger remove-entry-row"><i class="bi bi-trash"></i></button></div>
        `;
        entriesContainer.appendChild(row);
        new TomSelect(row.querySelector('.konto-select'), { create: false, sortField: { field: "text", direction: "asc" } });
    }

    function updateTotals() {
        let totalDebet = 0, totalKredit = 0;
        entriesContainer.querySelectorAll('.entry-row').forEach(row => {
            totalDebet += parseFloat(row.querySelector('.debet-input').value) || 0;
            totalKredit += parseFloat(row.querySelector('.kredit-input').value) || 0;
        });
        document.getElementById('total-debet').textContent = totalDebet.toFixed(2);
        document.getElementById('total-kredit').textContent = totalKredit.toFixed(2);
        const balance = totalDebet - totalKredit;
        const balanceEl = document.getElementById('balance');
        balanceEl.textContent = balance.toFixed(2);
        balanceEl.classList.toggle('text-danger', Math.abs(balance) > 0.01);
        balanceEl.classList.toggle('text-success', Math.abs(balance) <= 0.01);
    }
    
    function fillEntries(entries) {
        entriesContainer.innerHTML = '';
        if (entries && entries.length > 0) {
            entries.forEach(entry => createEntryRow(entry));
        }
        updateTotals();
    }

    async function populateAndShowModal(invoiceId, suggestion = null) {
        modalForm.reset();
        document.getElementById('modal-entry-id').value = '';
        document.getElementById('modal-entry-type').value = 'invoice';
        document.getElementById('modal-invoice-ids').value = invoiceId;
        document.getElementById('modal-attachment-ids').value = '';
        document.getElementById('delete-entry-btn-modal').style.display = 'none';
        askAiBtnModal.dataset.invoiceId = invoiceId; // Sätt ID på AI-knappen i modalen

        document.getElementById('modal-bank-event-info').style.display = 'none';
        document.getElementById('modal-underlag-section').style.display = 'none';

        const response = await fetch(`/api/invoice/${invoiceId}/details`);
        const invoiceData = await response.json();

        modalLabel.textContent = `Bokför Faktura ${invoiceData.number}`;
        document.getElementById('modal-bokforingsdag').value = invoiceData.paid_at || invoiceData.date;
        document.getElementById('modal-referens').value = `Faktura ${invoiceData.number}`;

        const invoiceInfoSection = document.getElementById('modal-invoice-info');
        document.getElementById('invoice-info-number').textContent = invoiceData.number;
        document.getElementById('invoice-info-date').textContent = invoiceData.date || 'N/A';
        document.getElementById('invoice-info-paid-at').textContent = invoiceData.paid_at || 'Ej betald';
        document.getElementById('invoice-info-sum').textContent = parseFloat(invoiceData.sum).toFixed(2);
        document.getElementById('invoice-info-tax').textContent = parseFloat(invoiceData.tax).toFixed(2);
        document.getElementById('invoice-info-net').textContent = parseFloat(invoiceData.net).toFixed(2);
        invoiceInfoSection.style.display = 'block';
        
        const markPaidBtn = document.getElementById('mark-paid-btn');
        markPaidBtn.dataset.invoiceId = invoiceId;
        markPaidBtn.style.display = invoiceData.paid_at ? 'none' : 'block';

        const underlagList = document.getElementById('underlag-list');
        underlagList.innerHTML = `<li class="list-group-item">Faktura <a href="/api/invoice/${invoiceId}/pdf" target="_blank">${invoiceData.number}</a></li>`;

        let entries = suggestion ? suggestion.entries : [];
        if (entries.length === 0) {
            if (accountingMethod === 'faktura') {
                entries = [
                    { account: '1510', debit: invoiceData.sum },
                    { account: '2611', credit: invoiceData.tax },
                    { account: '3001', credit: invoiceData.net }
                ];
            } else {
                entries = [
                    { account: '1930', debit: invoiceData.sum },
                    { account: '2611', credit: invoiceData.tax },
                    { account: '3001', credit: invoiceData.net }
                ];
            }
        }
        fillEntries(entries);
        genericEntryModal.show();
    }

    // --- Händelselyssnare ---

    document.getElementById('add-entry-row').addEventListener('click', () => createEntryRow());
    entriesContainer.addEventListener('click', e => {
        if (e.target.closest('.remove-entry-row')) {
            e.target.closest('.entry-row').remove();
            updateTotals();
        }
    });
    entriesContainer.addEventListener('input', e => {
        if (e.target.classList.contains('debet-input') || e.target.classList.contains('kredit-input')) {
            updateTotals();
        }
    });

    tableBody.addEventListener('click', async function(e) {
        const row = e.target.closest('.invoice-row');
        const isCheckbox = e.target.closest('.invoice-checkbox');
        const isAiButton = e.target.closest('.ask-ai-btn-table');
        const isSwitch = e.target.closest('.reverse-charge-switch');

        if (row && !isCheckbox && !isAiButton && !isSwitch) {
            const invoiceId = row.dataset.invoiceId;
            await populateAndShowModal(invoiceId);
        }
    });
    
    document.getElementById('mark-paid-btn').addEventListener('click', async function(e) {
        // ... (befintlig kod)
    });

    modalForm.addEventListener('submit', async function(e) {
        // ... (befintlig kod)
    });

    async function fetchAiSuggestion(invoiceId, button) {
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Laddar...';
        try {
            const response = await fetch(`/api/invoice/${invoiceId}/ask_gemini`, { method: 'POST' });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Okänt AI-fel');
            return result.suggestion;
        } catch (error) {
            alert(`AI-fel: ${error.message}`);
            return null;
        } finally {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-robot me-1"></i>AI';
        }
    }

    // Hantera klick på AI-knappen i tabellen
    tableBody.addEventListener('click', async function(e) {
        const aiButton = e.target.closest('.ask-ai-btn-table');
        if (aiButton) {
            e.stopPropagation();
            const invoiceId = aiButton.dataset.invoiceId;
            const suggestion = await fetchAiSuggestion(invoiceId, aiButton);
            if (suggestion) {
                await populateAndShowModal(invoiceId, suggestion);
            }
        }
    });

    // Hantera klick på AI-knappen i modalen
    askAiBtnModal.addEventListener('click', async function(e) {
        const invoiceId = e.target.dataset.invoiceId;
        const suggestion = await fetchAiSuggestion(invoiceId, e.target);
        if (suggestion) {
            fillEntries(suggestion.entries);
        }
    });

    // Hantera ändring av "Omvänd skattskyldighet"-switch
    tableBody.addEventListener('change', async function(e) {
        const aSwitch = e.target.closest('.reverse-charge-switch');
        if (aSwitch) {
            e.stopPropagation();
            const invoiceId = aSwitch.dataset.invoiceId;
            const isChecked = aSwitch.checked;
            aSwitch.disabled = true;

            try {
                const response = await fetch(`/api/invoice/${invoiceId}/toggle_reverse_charge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reverse_charge: isChecked })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Okänt fel');
                
                // Uppdatera data-attributet på raden
                const row = document.getElementById(`invoice-row-${invoiceId}`);
                if(row) row.dataset.reverseCharge = isChecked.toString();

            } catch (error) {
                alert(`Kunde inte uppdatera status: ${error.message}`);
                aSwitch.checked = !isChecked; // Återställ vid fel
            } finally {
                aSwitch.disabled = false;
            }
        }
    });

    // --- Batch Booking Logic (Logik utelämnad för korthet) ---
});
</script>
{% endblock %}
