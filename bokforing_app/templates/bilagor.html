{% extends 'base.html' %}

{# === Заголовок страницы === #}
{% block title %}Bilaga-inkorg - {{ company.name }}{% endblock %}

{# === Основное содержимое страницы === #}
{% block content %}
<h2>Bilaga-inkorg: {{ company.name }}</h2>
<p class="text-muted">Ladda upp, redigera och bokför dina kvitton/fakturor här.</p>

<!-- === Форма для загрузки файлов === -->
<div class="card bg-light my-4">
    <div class="card-body">
        <h5 class="card-title">Ladda upp nya bilagor</h5>
        <form id="multi-bilaga-form" class="mb-3">
            <label for="multi_bilaga_files" class="form-label">Välj filer (PDF, PNG, JPG)</label>
            <input class="form-control" type="file" id="multi_bilaga_files" name="files" multiple>
            <button type="submit" class="btn btn-primary btn-sm mt-2" id="multi-upload-btn">Ladda upp Bilagor</button>
            <!-- Спиннер для индикации процесса загрузки -->
            <div id="multi-upload-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;">
                <span class="visually-hidden">Laddar...</span>
            </div>
        </form>
    </div>
</div>

<!-- === Таблица с квитанциями === -->
<div class="table-responsive">
    <table class="table table-hover">
        <thead>
            <tr>
                <th data-sort-index="0" data-sort-type="text" style="cursor: pointer;">Säljare / Filnamn</th>
                <th data-sort-index="1" data-sort-type="date" style="cursor: pointer;">Fakturadatum</th>
                <th data-sort-index="2" data-sort-type="number" style="cursor: pointer;">Belopp (Brutto)</th>
                <th data-sort-index="3" data-sort-type="text" style="cursor: pointer;">Föreslaget Konto</th>
                <th data-sort-index="4" data-sort-type="text" style="cursor: pointer;">Status</th>
                <th>Åtgärd</th>
            </tr>
        </thead>
        <tbody id="bilagor-table-body">
            {# Если квитанций нет, показываем сообщение #}
            {% if not all_bilagor %}
                <tr id="no-bilagor-in-inbox"><td colspan="6" class="text-muted">Inkorgen är tom.</td></tr>
            {% endif %}

            {# Цикл для отображения каждой квитанции (bilaga) #}
            {% for bilaga in all_bilagor %}
                <tr id="bilaga-card-{{ bilaga.id }}">
                    <td>
                        <a href="#" class="bilaga-preview-link"
                           data-url="{{ url_for('static', filename='uploads/' ~ bilaga.filepath|replace('\\', '/') ) }}"
                           data-bs-toggle="modal"
                           data-bs-target="#previewModal">
                            <strong>{{ bilaga.saljare_namn or bilaga.filename }}</strong>
                        </a>
                        {% if bilaga.saljare_namn %}
                            <br><small class="text-muted">{{ bilaga.filename }}</small>
                        {% endif %}
                    </td>
                    <td>{{ bilaga.fakturadatum.strftime('%Y-%m-%d') if bilaga.fakturadatum else '---' }}</td>
                    {# Используем кастомный фильтр 'currency' для форматирования суммы #}
                    <td>{{ bilaga.brutto_amount | currency if bilaga.brutto_amount else '---' }}</td>
                    <td>
                        {% if bilaga.suggested_konto %}
                            <span class="badge bg-light text-dark" style="border: 1px solid #ccc;"
                                  title="{{ bilaga.suggested_konto }}">
                                {{ kontoplan.get(bilaga.suggested_konto, bilaga.suggested_konto) }}
                            </span>
                        {% else %}
                            ---
                        {% endif %}
                    </td>
                    <td>
                        {% if bilaga.status == 'assigned' %}
                            <span class="badge bg-success">Bokförd</span>
                        {% else %}
                            <span class="badge bg-warning text-dark">Obokförd</span>
                        {% endif %}
                    </td>
                    <td>
                        {# Кнопка "Redigera" (Редактировать). Содержит все данные квитанции в data-атрибутах #}
                        <button class="btn btn-secondary btn-sm edit-metadata-btn"
                                data-bs-toggle="modal"
                                data-bs-target="#bokforBilagaModal"
                                data-bilaga-id="{{ bilaga.id }}"
                                data-filename="{{ bilaga.saljare_namn or bilaga.filename }}"
                                data-date="{{ bilaga.fakturadatum.strftime('%Y-%m-%d') if bilaga.fakturadatum else '' }}"
                                data-brutto="{{ bilaga.brutto_amount if bilaga.brutto_amount else '0.00' }}"
                                data-netto="{{ bilaga.netto_amount if bilaga.netto_amount else '0.00' }}"
                                data-moms="{{ bilaga.moms_amount if bilaga.moms_amount else '0.00' }}"
                                data-konto="{{ bilaga.suggested_konto if bilaga.suggested_konto else '' }}"
                                data-fakturanr="{{ bilaga.fakturanr or '' }}"
                                data-ocr="{{ bilaga.ocr or '' }}"
                                data-forfallodag="{{ bilaga.forfallodag.strftime('%Y-%m-%d') if bilaga.forfallodag else '' }}"
                                data-saljare-namn="{{ bilaga.saljare_namn or '' }}"
                                data-saljare-orgnr="{{ bilaga.saljare_orgnr or '' }}"
                                data-saljare-bankgiro="{{ bilaga.saljare_bankgiro or '' }}"
                                data-kund-namn="{{ bilaga.kund_namn or '' }}"
                                data-kund-orgnr="{{ bilaga.kund_orgnr or '' }}"
                                data-kund-nummer="{{ bilaga.kund_nummer or '' }}">
                            Redigera
                        </button>

                        {# Кнопка "Bokför" (Провести) появляется только для необработанных квитанций #}
                        {% if bilaga.status == 'unassigned' %}
                            <button class="btn btn-success btn-sm bokfor-bilaga-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#bokforBilagaModal"
                                    data-bilaga-id="{{ bilaga.id }}"
                                    data-filename="{{ bilaga.saljare_namn or bilaga.filename }}"
                                    data-date="{{ bilaga.fakturadatum.strftime('%Y-%m-%d') if bilaga.fakturadatum else '' }}"
                                    data-brutto="{{ bilaga.brutto_amount if bilaga.brutto_amount else '0.00' }}"
                                    data-netto="{{ bilaga.netto_amount if bilaga.netto_amount else '0.00' }}"
                                    data-moms="{{ bilaga.moms_amount if bilaga.moms_amount else '0.00' }}"
                                    data-konto="{{ bilaga.suggested_konto if bilaga.suggested_konto else '' }}">
                                Bokför
                            </button>
                        {% endif %}
                        {# Кнопка "Ta bort" (Удалить) #}
                        <button class="btn btn-danger btn-sm delete-bilaga-btn" data-bilaga-id="{{ bilaga.id }}">Ta bort</button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- === Модальное окно для предпросмотра PDF === -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">Förhandsgranskning</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <embed id="bilaga-preview-embed" src="" type="application/pdf" width="100%" height="600px" style="border: 1px solid #ccc;">
            </div>
        </div>
    </div>
</div>

<!-- === Модальное окно для редактирования и проводки === -->
<div class="modal fade" id="bokforBilagaModal" tabindex="-1" aria-labelledby="bokforBilagaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bokforBilagaModalLabel">Bokför / Redigera Bilaga</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div id="bokfor-modal-alert" class="alert alert-danger" style="display: none;" role="alert"></div>

                <input type="hidden" id="bokfor-bilaga-id">

                <!-- Верхняя часть: Текст верификации и дата -->
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="bokfor-ver-text" class="form-label">Verifikationstext</label>
                        <input type="text" class="form-control" id="bokfor-ver-text" placeholder="Faktura...">
                    </div>
                    <div class="col-md-6">
                        <label for="bokfor-datum" class="form-label">Datum</label>
                        <input type="date" class="form-control" id="bokfor-datum">
                    </div>
                </div>

                <hr>
                
                <!-- Средняя часть: Редактируемые метаданные -->
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="metadata-saljare-namn" class="form-label">Säljare Namn</label>
                        <input type="text" class="form-control" id="metadata-saljare-namn">
                    </div>
                    <div class="col-md-6">
                        <label for="metadata-saljare-orgnr" class="form-label">Säljare Org.Nr</label>
                        <input type="text" class="form-control" id="metadata-saljare-orgnr">
                    </div>
                    <div class="col-md-6">
                        <label for="metadata-kund-namn" class="form-label">Kund Namn</label>
                        <input type="text" class="form-control" id="metadata-kund-namn">
                    </div>
                    <div class="col-md-6">
                        <label for="metadata-kund-orgnr" class="form-label">Kund Org.Nr</label>
                        <input type="text" class="form-control" id="metadata-kund-orgnr">
                    </div>
                    <div class="col-md-6">
                        <label for="metadata-fakturanr" class="form-label">Fakturanummer</label>
                        <input type="text" class="form-control" id="metadata-fakturanr">
                    </div>
                    <div class="col-md-6">
                        <label for="metadata-ocr" class="form-label">OCR</label>
                        <input type="text" class="form-control" id="metadata-ocr">
                    </div>
                    <div class="col-md-6">
                        <label for="metadata-fakturadatum" class="form-label">Fakturadatum</label>
                        <input type="date" class="form-control" id="metadata-fakturadatum">
                    </div>
                    <div class="col-md-6">
                        <label for="metadata-forfallodag" class="form-label">Förfallodag</label>
                        <input type="date" class="form-control" id="metadata-forfallodag">
                    </div>
                    <div class="col-md-4">
                        <label for="metadata-total-amount" class="form-label">Bruttobelopp</label>
                        <input type="number" step="0.01" class="form-control" id="metadata-total-amount">
                    </div>
                    <div class="col-md-4">
                        <label for="metadata-moms-amount" class="form-label">Moms</label>
                        <input type="number" step="0.01" class="form-control" id="metadata-moms-amount">
                    </div>
                </div>

                <!-- Нижняя часть: Таблица бухгалтерских проводок -->
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Konto</th>
                            <th>Debet</th>
                            <th>Kredit</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="bokfor-entries-container">
                        {# Шаблон для новой строки проводки, используется JavaScript #}
                        <template id="entry-row-template">
                            <tr>
                                <td><input type="text" class="konto-input" placeholder="Välj konto..."></td>
                                <td><input type="number" step="0.01" class="form-control form-control-sm debet-input" placeholder="0.00"></td>
                                <td><input type="number" step="0.01" class="form-control form-control-sm kredit-input" placeholder="0.00"></td>
                                <td><button type="button" class="btn btn-danger btn-sm remove-row-btn">X</button></td>
                            </tr>
                        </template>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td><strong>Summa:</strong></td>
                            <td><strong id="bokfor-total-debet">0.00</strong></td>
                            <td><strong id="bokfor-total-kredit">0.00</strong></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="2"><strong>Differens:</strong></td>
                            <td colspan="2"><strong id="bokfor-total-diff" class="text-danger">0.00</strong></td>
                        </tr>
                    </tfoot>
                </table>
                <button type="button" class="btn btn-outline-primary btn-sm" id="bokfor-add-row-btn">Lägg till rad</button>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                <button type="button" class="btn btn-primary" id="bokfor-save-btn">Spara & Bokför</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{# === Скрипты, специфичные для этой страницы === #}
{% block scripts %}
<script>
    // Передаем данные из Flask в JavaScript
    const KONTOPLAN = {{ kontoplan|tojson }};
    const ASSOCIATION_MAP = {{ association_map|tojson }};
    const COMPANY_ID = {{ company.id }};
</script>

{# Подключаем необходимые JS-файлы #}
<script src="{{ url_for('static', filename='js/mainTable.js') }}"></script>
<script src="{{ url_for('static', filename='js/kontoAutocomplete.js') }}"></script>
<script src="{{ url_for('static', filename='js/bilagaPage.js') }}"></script>

{# Скрипт для модального окна предпросмотра #}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const previewModal = document.getElementById('previewModal');
        if (previewModal) {
            previewModal.addEventListener('show.bs.modal', function(event) {
                const link = event.relatedTarget;
                const fileUrl = link.dataset.url;
                const embed = document.getElementById('bilaga-preview-embed');
                embed.setAttribute('src', fileUrl);
            });
        }
    });
</script>
{% endblock %}
