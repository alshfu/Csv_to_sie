{% extends 'base.html' %}
{% block title %}Bokföring - {{ company.name }}{% endblock %}
{% block page_title %}Obearbetade transaktioner{% endblock %}

{% block content %}
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-cloud-upload me-2"></i>Ladda upp CSV med transaktioner</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('api.upload_csv', company_id=company.id) }}" method="POST" enctype="multipart/form-data">
                        <div class="input-group">
                            <input type="file" class="form-control" name="csv_file" accept=".csv" required>
                            <button class="btn btn-primary" type="submit"><i class="bi bi-upload me-1"></i>Ladda upp</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="bi bi-list-ul me-2"></i>Väntar på bokföring</h4>
            <button id="batch-book-btn" class="btn btn-success" disabled>
                <i class="bi bi-check-circle me-1"></i>Bokför markerade (<span id="selected-count">0</span>)
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0">
                    <thead>
                        <tr>
                            <th scope="col" class="text-center" style="width: 50px;">
                                <input type="checkbox" id="select-all-checkbox" class="form-check-input"></th>
                            <th scope="col">Datum</th>
                            <th scope="col">Referens</th>
                            <th scope="col" class="text-end">Belopp</th>
                            <th scope="col">Status</th>
                            <th scope="col" class="text-end">Åtgärd</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-table-body">
                        {% for trans in transactions %}
                            <tr id="trans-row-{{ trans.id }}" class="transaction-row" data-trans-id="{{ trans.id }}" style="cursor: pointer;">
                                <td class="text-center"><input type="checkbox" class="form-check-input transaction-checkbox" data-trans-id="{{ trans.id }}"></td>
                                <td class="fw-medium">{{ trans.bokforingsdag.strftime('%Y-%m-%d') }}</td>
                                <td>{{ trans.referens }}</td>
                                <td class="text-end fw-bold {% if trans.belopp < 0 %}text-danger{% else %}text-success{% endif %}">{{ "%.2f"|format(trans.belopp) }} kr</td>
                                <td><span class="badge bg-warning text-dark">{{ trans.status }}</span></td>
                                <td class="text-end">
                                    <button class="btn btn-outline-primary btn-sm ask-ai-btn" data-trans-id="{{ trans.id }}" title="Få bokföringsförslag">
                                        <i class="bi bi-robot me-1"></i>AI
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% include '_generic_entry_modal.html' %}
{% endblock %}

{% block scripts %}
<script defer>
document.addEventListener('DOMContentLoaded', async function() {
    const companyId = {{ company.id }};
    const kontoplan = {{ kontoplan|tojson }};
    const genericEntryModal = new bootstrap.Modal(document.getElementById('genericEntryModal'));
    const modalForm = document.getElementById('genericEntryForm');
    const entriesContainer = document.getElementById('entries-container');
    const tableBody = document.getElementById('transactions-table-body');
    const modalLabel = document.getElementById('genericEntryModalLabel');
    const invoiceSelectEl = document.getElementById('invoice-select');
    const attachmentSelectEl = document.getElementById('attachment-select');
    const underlagList = document.getElementById('underlag-list');
    const saveBtn = document.getElementById('save-entry-btn');
    const saveBtnSpinner = saveBtn.querySelector('.spinner-border');
    
    let invoiceTomSelect, attachmentTomSelect;
    let availableInvoices = [], availableAttachments = [];

    try {
        const [invoicesRes, attachmentsRes] = await Promise.all([
            fetch(`/api/company/${companyId}/invoices?booked=false`),
            fetch(`/api/company/${companyId}/attachments?assigned=false`)
        ]);
        availableInvoices = await invoicesRes.json();
        availableAttachments = await attachmentsRes.json();
    } catch (error) {
        console.error("Kunde inte ladda underlag:", error);
        showToast("Kunde inte ladda tillgängliga fakturor och bilagor.", "danger");
    }

    function initializeUnderlagSelectors() {
        if (invoiceTomSelect) invoiceTomSelect.destroy();
        if (attachmentTomSelect) attachmentTomSelect.destroy();

        invoiceTomSelect = new TomSelect(invoiceSelectEl, {
            valueField: 'id',
            labelField: 'display_name',
            searchField: ['display_name'],
            options: availableInvoices,
            plugins: ['remove_button'],
            onChange: updateUnderlagListAndHiddenInput,
        });

        attachmentTomSelect = new TomSelect(attachmentSelectEl, {
            valueField: 'id',
            labelField: 'filename',
            searchField: ['filename'],
            options: availableAttachments,
            plugins: ['remove_button'],
            onChange: updateUnderlagListAndHiddenInput,
        });
    }

    function updateUnderlagListAndHiddenInput() {
        underlagList.innerHTML = '';
        const selectedInvoiceIds = invoiceTomSelect.getValue();
        const selectedAttachmentIds = attachmentTomSelect.getValue();

        selectedInvoiceIds.forEach(id => {
            const item = availableInvoices.find(i => i.id == id);
            if (item) underlagList.innerHTML += `<li class="list-group-item">Faktura: ${item.display_name}</li>`;
        });
        selectedAttachmentIds.forEach(id => {
            const item = availableAttachments.find(a => a.id == id);
            if (item) underlagList.innerHTML += `<li class="list-group-item">Bilaga: <a href="${item.url}" target="_blank">${item.filename}</a></li>`;
        });

        document.getElementById('modal-invoice-ids').value = selectedInvoiceIds.join(',');
        document.getElementById('modal-attachment-ids').value = selectedAttachmentIds.join(',');
    }
    
    initializeUnderlagSelectors();

    async function populateGenericEntryModal(data, type) {
        modalForm.reset();
        document.getElementById('modal-entry-id').value = data.id;
        document.getElementById('modal-entry-type').value = type;
        modalLabel.textContent = `Bokför ${type === 'transaction' ? 'transaktion' : type}`;
        document.getElementById('modal-bokforingsdag').value = data.bokforingsdag;
        document.getElementById('modal-referens').value = data.referens;

        document.getElementById('modal-invoice-info').style.display = 'none';
        document.getElementById('modal-bank-event-info').style.display = 'block';
        document.getElementById('modal-underlag-section').style.display = 'block';

        entriesContainer.innerHTML = '';
        data.entries.forEach(entry => createEntryRow(entriesContainer, kontoplan, entry));
        if (data.entries.length === 0) {
            const bankAmount = data.bank_event ? data.bank_event.amount : 0;
            createEntryRow(entriesContainer, kontoplan, { konto: '1930', debet: bankAmount > 0 ? bankAmount : '', kredit: bankAmount < 0 ? -bankAmount : '' });
            createEntryRow(entriesContainer, kontoplan);
        }
        updateTotals(entriesContainer);

        const bankEventInfo = document.getElementById('modal-bank-event-info');
        if (data.bank_event) {
            bankEventInfo.style.display = 'block';
            document.getElementById('bank-event-date').textContent = data.bank_event.date;
            document.getElementById('bank-event-ref').textContent = data.bank_event.ref;
            document.getElementById('bank-event-amount').textContent = data.bank_event.amount;
        } else {
            bankEventInfo.style.display = 'none';
        }

        invoiceTomSelect.setValue(data.invoice_ids || []);
        attachmentTomSelect.setValue(data.attachment_ids || []);
        updateUnderlagListAndHiddenInput();
    }

    document.getElementById('add-entry-row').addEventListener('click', () => createEntryRow(entriesContainer, kontoplan));
    entriesContainer.addEventListener('click', e => {
        if (e.target.closest('.remove-entry-row')) {
            e.target.closest('.entry-row').remove();
            updateTotals(entriesContainer);
        }
    });
    entriesContainer.addEventListener('input', e => {
        if (e.target.classList.contains('debet-input') || e.target.classList.contains('kredit-input')) {
            updateTotals(entriesContainer);
        }
    });

    tableBody.addEventListener('click', async function(e) {
        const row = e.target.closest('.transaction-row');
        if (row && !e.target.closest('.transaction-checkbox') && !e.target.closest('.ask-ai-btn')) {
            const transId = row.dataset.transId;
            const response = await fetch(`/api/verifikation/${transId}`);
            const data = await response.json();
            await populateGenericEntryModal(data, 'transaction');
            genericEntryModal.show();
        }
    });

    modalForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        saveBtn.disabled = true;
        saveBtnSpinner.classList.remove('d-none');

        const transId = document.getElementById('modal-entry-id').value;
        const url = transId ? `/api/verifikation/${transId}` : `/api/company/${companyId}/verifikation`;
        const method = transId ? 'PUT' : 'POST';

        const data = {
            bokforingsdag: document.getElementById('modal-bokforingsdag').value,
            referens: document.getElementById('modal-referens').value,
            invoice_ids: document.getElementById('modal-invoice-ids').value.split(',').filter(id => id),
            attachment_ids: document.getElementById('modal-attachment-ids').value.split(',').filter(id => id),
            entries: []
        };

        entriesContainer.querySelectorAll('.entry-row').forEach(row => {
            const konto = row.querySelector('.konto-select').value;
            const debet = parseFloat(row.querySelector('.debet-input').value) || 0;
            const kredit = parseFloat(row.querySelector('.kredit-input').value) || 0;
            if (konto && (debet > 0 || kredit > 0)) {
                data.entries.push({ konto, debet, kredit });
            }
        });

        if (Math.abs(parseFloat(document.getElementById('balance').textContent)) > 0.01) {
            showToast('Fel: Debet och Kredit måste vara i balans.', 'danger');
            saveBtn.disabled = false;
            saveBtnSpinner.classList.add('d-none');
            return;
        }
        if (data.entries.length < 2) {
            showToast('Fel: Du måste ha minst två bokföringsposter.', 'danger');
            saveBtn.disabled = false;
            saveBtnSpinner.classList.add('d-none');
            return;
        }

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Ett fel inträffade.');

            genericEntryModal.hide();
            showToast('Verifikationen har sparats!', 'success');
            setTimeout(() => location.reload(), 1500);
        } catch (error) {
            showToast(`Kunde inte spara verifikationen: ${error.message}`, 'danger');
        } finally {
            saveBtn.disabled = false;
            saveBtnSpinner.classList.add('d-none');
        }
    });

    tableBody.addEventListener('click', async function(e) {
        const aiButton = e.target.closest('.ask-ai-btn');
        if (aiButton) {
            e.stopPropagation();
            const transId = aiButton.dataset.transId;
            aiButton.disabled = true;
            aiButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Laddar...';

            try {
                const response = await fetch(`/api/transaction/${transId}/ask_gemini`, { method: 'POST' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Okänt AI-fel');

                const transResponse = await fetch(`/api/verifikation/${transId}`);
                const transData = await transResponse.json();

                transData.entries = result.suggestion.entries;
                await populateGenericEntryModal(transData, 'transaction');
                genericEntryModal.show();

            } catch (error) {
                showToast(`AI-fel: ${error.message}`, 'danger');
            } finally {
                aiButton.disabled = false;
                aiButton.innerHTML = '<i class="bi bi-robot me-1"></i>AI';
            }
        }
    });

    // --- Batch selection logic ---
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const batchBookBtn = document.getElementById('batch-book-btn');
    const selectedCountSpan = document.getElementById('selected-count');

    function updateBatchButtonState() {
        const transactionCheckboxes = document.querySelectorAll('.transaction-checkbox');
        const selectedCheckboxes = document.querySelectorAll('.transaction-checkbox:checked');
        const count = selectedCheckboxes.length;
        
        selectedCountSpan.textContent = count;
        batchBookBtn.disabled = count === 0;

        if (count === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (count === transactionCheckboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }

    selectAllCheckbox.addEventListener('change', function() {
        const transactionCheckboxes = document.querySelectorAll('.transaction-checkbox');
        transactionCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateBatchButtonState();
    });

    tableBody.addEventListener('change', function(e) {
        if (e.target.classList.contains('transaction-checkbox')) {
            updateBatchButtonState();
        }
    });

    batchBookBtn.addEventListener('click', async function() {
        const selectedIds = Array.from(document.querySelectorAll('.transaction-checkbox:checked'))
                                 .map(cb => cb.dataset.transId);

        if (selectedIds.length === 0) {
            showToast('Inga transaktioner markerade.', 'info');
            return;
        }

        this.disabled = true;
        this.innerHTML = `<span class="spinner-border spinner-border-sm me-1"></span>Bokför...`;

        try {
            const response = await fetch('/api/batch_book_with_ai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ transaction_ids: selectedIds })
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || 'Ett serverfel inträffade.');
            }
            
            let message = '';
            if (result.success_ids && result.success_ids.length > 0) {
                message += `${result.success_ids.length} transaktioner bokfördes. `;
                result.success_ids.forEach(id => {
                    const row = document.getElementById(`trans-row-${id}`);
                    if (row) row.remove();
                });
            }

            if (result.errors && result.errors.length > 0) {
                const errorDetails = result.errors.map(e => `ID ${e.id}: ${e.error}`).join(', ');
                message += `${result.errors.length} misslyckades: ${errorDetails}`;
                showToast(message, 'warning');
            } else if (result.success_ids && result.success_ids.length > 0) {
                showToast(message, 'success');
            } else {
                 showToast('Inga transaktioner kunde bokföras.', 'info');
            }
            
        } catch (error) {
            showToast(`Ett fel inträffade: ${error.message}`, 'danger');
        } finally {
            // Update state after potential removals
            const remainingCheckboxes = document.querySelectorAll('.transaction-checkbox:checked').length;
            this.innerHTML = `<i class="bi bi-check-circle me-1"></i>Bokför markerade (<span id="selected-count">${remainingCheckboxes}</span>)`;
            updateBatchButtonState();
        }
    });
    
    // Initial state update in case of page reload with checked boxes
    updateBatchButtonState();
});
</script>
{% endblock %}