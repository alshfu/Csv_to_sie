{% extends 'base.html' %}
{% block title %}Bokföring - {{ company.name }}{% endblock %}

{% block content %}
    <h2>Bokföring: {{ company.name }}</h2>

    <div class="d-flex justify-content-between align-items-center my-4">
        <div class="card bg-light flex-grow-1 me-3">
            <div class="card-body">
                <h5 class="card-title">Ladda upp ny CSV (Banktransaktioner)</h5>
                <form action="{{ url_for('api.upload_csv', company_id=company.id) }}" method="POST" enctype="multipart/form-data">
                    <div class="input-group">
                        <input type="file" class="form-control" name="csv_file" accept=".csv" required>
                        <button class="btn btn-primary" type="submit">Ladda upp CSV</button>
                    </div>
                </form>
            </div>
        </div>
        <a href="{{ url_for('main.ai_settings_page') }}" class="btn btn-info">
            <i class="bi bi-robot"></i> AI-inställningar
        </a>
    </div>

    <div class="row mt-3">
        <div class="col-md-12">
            <h3>Obearbetade transaktioner</h3>
            <div class="mb-3">
                <button id="batch-book-btn" class="btn btn-success" disabled>
                    Bokför markerade med AI (<span id="selected-count">0</span>)
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-checkbox"></th>
                            <th>Datum</th>
                            <th>Referens</th>
                            <th class="text-end">Belopp</th>
                            <th>Status</th>
                            <th class="text-end">Åtgärd</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-table-body">
                        {% for trans in transactions %}
                            <tr id="trans-row-{{ trans.id }}" class="transaction-row" data-trans-id="{{ trans.id }}" style="cursor: pointer;">
                                <td><input type="checkbox" class="transaction-checkbox" data-trans-id="{{ trans.id }}"></td>
                                <td>{{ trans.bokforingsdag.strftime('%Y-%m-%d') }}</td>
                                <td>{{ trans.referens }}</td>
                                <td class="text-end">{{ "%.2f"|format(trans.belopp) }}</td>
                                <td><span class="badge bg-warning text-dark">{{ trans.status }}</span></td>
                                <td class="text-end">
                                    <button class="btn btn-outline-primary btn-sm ask-ai-btn" data-trans-id="{{ trans.id }}" title="Få bokföringsförslag">
                                        <i class="bi bi-robot"></i> AI
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <form action="{{ url_for('api.generate_sie', company_id=company.id) }}" method="POST" class="mt-3">
        <button type="submit" class="btn btn-success">Generera SIE-fil</button>
    </form>

    {% include '_verifikation_modal.html' %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const companyId = {{ company.id }};
    const kontoplan = {{ kontoplan|tojson }};
    const verifikationModal = new bootstrap.Modal(document.getElementById('verifikationModal'));
    const modalForm = document.getElementById('verifikationForm');
    const entriesContainer = document.getElementById('entries-container');
    const tableBody = document.getElementById('transactions-table-body');
    const modalLabel = document.getElementById('verifikationModalLabel');

    // --- Unified Modal Logic ---

    function createEntryRow(entry = {}) {
        const row = document.createElement('div');
        row.className = 'row g-2 mb-2 entry-row';
        row.innerHTML = `
            <div class="col-md-5"><select class="form-select konto-select" name="konto">${Object.entries(kontoplan).map(([nr, desc]) => `<option value="${nr}" ${entry.konto == nr ? 'selected' : ''}>${nr} - ${desc}</option>`).join('')}</select></div>
            <div class="col-md-3"><input type="number" class="form-control debet-input" name="debet" placeholder="Debet" value="${entry.debet || ''}" step="0.01"></div>
            <div class="col-md-3"><input type="number" class="form-control kredit-input" name="kredit" placeholder="Kredit" value="${entry.kredit || ''}" step="0.01"></div>
            <div class="col-md-1"><button type="button" class="btn btn-sm btn-outline-danger remove-entry-row"><i class="bi bi-trash"></i></button></div>
        `;
        entriesContainer.appendChild(row);
        new TomSelect(row.querySelector('.konto-select'), { create: false, sortField: { field: "text", direction: "asc" } });
    }

    function updateTotals() {
        let totalDebet = 0, totalKredit = 0;
        entriesContainer.querySelectorAll('.entry-row').forEach(row => {
            totalDebet += parseFloat(row.querySelector('.debet-input').value) || 0;
            totalKredit += parseFloat(row.querySelector('.kredit-input').value) || 0;
        });
        document.getElementById('total-debet').textContent = totalDebet.toFixed(2);
        document.getElementById('total-kredit').textContent = totalKredit.toFixed(2);
        const balance = totalDebet - totalKredit;
        const balanceEl = document.getElementById('balance');
        balanceEl.textContent = balance.toFixed(2);
        balanceEl.classList.toggle('text-danger', balance.toFixed(2) != '0.00');
        balanceEl.classList.toggle('text-success', balance.toFixed(2) == '0.00');
    }

    function populateModal(data) {
        document.getElementById('modal-trans-id').value = data.id;
        modalLabel.textContent = `Bokför transaktion ${data.id}`;
        document.getElementById('modal-bokforingsdag').value = data.bokforingsdag;
        document.getElementById('modal-referens').value = data.referens;
        
        entriesContainer.innerHTML = '';
        data.entries.forEach(entry => createEntryRow(entry));
        if (data.entries.length === 0) {
            const bankAmount = data.bank_event ? data.bank_event.amount : 0;
            createEntryRow({ konto: '1930', debet: bankAmount > 0 ? bankAmount : '', kredit: bankAmount < 0 ? -bankAmount : '' });
            createEntryRow();
        }
        updateTotals();

        const bankEventInfo = document.getElementById('modal-bank-event-info');
        if (data.bank_event) {
            bankEventInfo.style.display = 'block';
            document.getElementById('bank-event-date').textContent = data.bank_event.date;
            document.getElementById('bank-event-ref').textContent = data.bank_event.ref;
            document.getElementById('bank-event-amount').textContent = data.bank_event.amount;
        } else {
            bankEventInfo.style.display = 'none';
        }

        const attachmentsList = document.getElementById('attachments-list');
        attachmentsList.innerHTML = '';
        if (data.attachments && data.attachments.length > 0) {
            data.attachments.forEach(att => {
                attachmentsList.innerHTML += `<li class="list-group-item"><a href="${att.url}" target="_blank">${att.filename}</a></li>`;
            });
        } else {
            attachmentsList.innerHTML = '<li class="list-group-item">Inga bilagor kopplade.</li>';
        }
    }

    // --- Event Listeners ---

    document.getElementById('add-entry-row').addEventListener('click', () => createEntryRow());
    entriesContainer.addEventListener('click', e => {
        if (e.target.closest('.remove-entry-row')) {
            e.target.closest('.entry-row').remove();
            updateTotals();
        }
    });
    entriesContainer.addEventListener('input', e => {
        if (e.target.classList.contains('debet-input') || e.target.classList.contains('kredit-input')) {
            updateTotals();
        }
    });

    tableBody.addEventListener('click', async function(e) {
        const row = e.target.closest('.transaction-row');
        if (row && !e.target.closest('.transaction-checkbox') && !e.target.closest('.ask-ai-btn')) {
            const transId = row.dataset.transId;
            const response = await fetch(`/api/verifikation/${transId}`);
            const data = await response.json();
            populateModal(data);
            verifikationModal.show();
        }
    });

    // **FIXED** This is the restored submit handler for the modal form
    modalForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const transId = document.getElementById('modal-trans-id').value;
        if (!transId) return; // Should not happen on this page

        const url = `/api/verifikation/${transId}`;
        const method = 'PUT';

        const formData = new FormData(modalForm);
        const data = {
            bokforingsdag: formData.get('bokforingsdag'),
            referens: formData.get('referens'),
            entries: []
        };

        entriesContainer.querySelectorAll('.entry-row').forEach(row => {
            const konto = row.querySelector('.konto-select').value;
            const debet = parseFloat(row.querySelector('.debet-input').value) || 0;
            const kredit = parseFloat(row.querySelector('.kredit-input').value) || 0;
            if (konto && (debet > 0 || kredit > 0)) {
                data.entries.push({ konto, debet, kredit });
            }
        });

        if (parseFloat(document.getElementById('balance').textContent).toFixed(2) != '0.00') {
            alert('Fel: Debet och Kredit måste vara i balans.');
            return;
        }
        if (data.entries.length < 2) {
            alert('Fel: Du måste ha minst två bokföringsposter.');
            return;
        }

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Ett fel inträffade.');

            verifikationModal.hide();
            alert('Verifikationen har sparats!');
            location.reload();
        } catch (error) {
            alert(`Kunde inte spara verifikationen: ${error.message}`);
        }
    });
    
    tableBody.addEventListener('click', async function(e) {
        const aiButton = e.target.closest('.ask-ai-btn');
        if (aiButton) {
            e.stopPropagation();
            const transId = aiButton.dataset.transId;
            aiButton.disabled = true;
            aiButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            try {
                const response = await fetch(`/api/transaction/${transId}/ask_gemini`, { method: 'POST' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Okänt AI-fel');

                const transResponse = await fetch(`/api/verifikation/${transId}`);
                const transData = await transResponse.json();
                
                transData.entries = result.suggestion.entries;
                populateModal(transData);
                verifikationModal.show();

            } catch (error) {
                alert(`AI-fel: ${error.message}`);
            } finally {
                aiButton.disabled = false;
                aiButton.innerHTML = '<i class="bi bi-robot"></i> AI';
            }
        }
    });
    
    // --- Batch Booking Logic (oförändrad) ---
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const checkboxes = document.querySelectorAll('.transaction-checkbox');
    const batchBookBtn = document.getElementById('batch-book-btn');
    const selectedCountSpan = document.getElementById('selected-count');

    function updateBatchButton() {
        const selected = document.querySelectorAll('.transaction-checkbox:checked');
        selectedCountSpan.textContent = selected.length;
        batchBookBtn.disabled = selected.length === 0;
    }

    selectAllCheckbox.addEventListener('change', (e) => {
        checkboxes.forEach(cb => cb.checked = e.target.checked);
        updateBatchButton();
    });

    checkboxes.forEach(cb => cb.addEventListener('change', updateBatchButton));

    batchBookBtn.addEventListener('click', async () => {
        const selectedIds = Array.from(document.querySelectorAll('.transaction-checkbox:checked')).map(cb => cb.dataset.transId);
        if (selectedIds.length === 0) return;

        batchBookBtn.disabled = true;
        batchBookBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Bokför...';

        try {
            const response = await fetch('/api/batch_book_with_ai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ transaction_ids: selectedIds })
            });
            const result = await response.json();
            
            let message = `${result.success_ids.length} transaktioner bokfördes.`;
            if (result.errors.length > 0) {
                message += `\n${result.errors.length} misslyckades. Se konsolen för detaljer.`;
                console.error('Batch-fel:', result.errors);
            }
            alert(message);
            location.reload();

        } catch (error) {
            alert(`Ett allvarligt fel inträffade: ${error.message}`);
        } finally {
            batchBookBtn.disabled = false;
            batchBookBtn.innerHTML = `Bokför markerade med AI (<span id="selected-count">0</span>)`;
            updateBatchButton();
        }
    });
});
</script>
{% endblock %}
