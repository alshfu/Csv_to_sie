{% extends 'base.html' %}
{% block title %}Verifikationer - {{ company.name }}{% endblock %}

{% block content %}
    <h2>Verifikationer: {{ company.name }}</h2>

    <div class="table-responsive mt-4">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Ver. ID</th>
                    <th>Datum</th>
                    <th>Referens</th>
                    <th>Belopp</th>
                    <th>Konton</th>
                    <th>Åtgärd</th>
                </tr>
            </thead>
            <tbody id="verifikationer-table-body">
                {% for trans in transactions %}
                    <tr id="ver-row-{{ trans.id }}">
                        <td>{{ trans.id }}</td>
                        <td>{{ trans.bokforingsdag.strftime('%Y-%m-%d') }}</td>
                        <td>{{ trans.referens }}</td>
                        <td>{{ "%.2f"|format(trans.belopp) }}</td>
                        <td>
                            {% for entry in trans.entries %}
                                <span class="badge bg-light text-dark" style="border: 1px solid #ccc;" title="{{ entry.konto }}">
                                    {{ kontoplan.get(entry.konto, entry.konto) }}
                                </span>
                            {% endfor %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger delete-ver-btn" data-trans-id="{{ trans.id }}" title="Ta bort verifikation">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="6" class="text-center">Inga verifikationer hittades.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tableBody = document.getElementById('verifikationer-table-body');

    tableBody.addEventListener('click', async function(e) {
        const deleteBtn = e.target.closest('.delete-ver-btn');
        if (!deleteBtn) return;

        const transId = deleteBtn.dataset.transId;
        if (!confirm(`Är du säker på att du vill ta bort verifikation ${transId}? Transaktionen kommer att återställas till obearbetad.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/verifikation/${transId}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.error || 'Ett okänt fel inträffade.');
            }
            
            // Ta bort raden från tabellen
            const row = document.getElementById(`ver-row-${transId}`);
            if (row) {
                row.remove();
            }
            // Du kan lägga till en flash-liknande notis här om du vill
            alert('Verifikationen har tagits bort och transaktionen har återställts.');

        } catch (error) {
            console.error('Fel vid borttagning:', error);
            alert(`Kunde inte ta bort verifikationen: ${error.message}`);
        }
    });
});
</script>
{% endblock %}
