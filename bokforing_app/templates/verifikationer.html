{% extends 'base.html' %}
{% block title %}Verifikationer - {{ company.name }}{% endblock %}

{% block content %}
    <div class="container-fluid py-4">
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="h2 mb-0 fw-bold text-primary">
                        <i class="bi bi-journal-plus me-2"></i>
                        Verifikationer: {{ company.name }}
                    </h2>
                    <button id="new-ver-btn" class="btn btn-primary btn-lg">
                        <i class="bi bi-plus-circle me-1"></i>
                        Skapa ny verifikation
                    </button>
                </div>
            </div>
        </div>

        <!-- Verifications Table Section -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0 align-middle sortable-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col" class="sortable" data-sort="id" style="width: 60px;">
                                            <span>Ver. ID</span>
                                            <i class="bi bi-arrow-up-down ms-1"></i>
                                        </th>
                                        <th scope="col" class="sortable" data-sort="date" style="width: 10ch;">
                                            <span>Datum</span>
                                            <i class="bi bi-arrow-up-down ms-1"></i>
                                        </th>
                                        <th scope="col" class="text-center" style="width: 200px;">Konton</th>
                                        <th scope="col" class="text-end sortable" data-sort="amount" style="width: 120px;">
                                            <span>Belopp</span>
                                            <i class="bi bi-arrow-up-down ms-1"></i>
                                        </th>
                                        <th scope="col" class="sortable" data-sort="ref" style="width: 200px;">
                                            <span>Referens</span>
                                            <i class="bi bi-arrow-up-down ms-1"></i>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="verifikationer-table-body">
                                    {% for trans in transactions %}
                                        <tr id="ver-row-{{ trans.id }}" class="ver-row" data-trans-id="{{ trans.id }}" style="cursor: pointer;" data-id="{{ trans.id }}" data-date="{{ trans.bokforingsdag.strftime('%Y-%m-%d') }}" data-ref="{{ trans.referens }}" data-amount="{{ trans.belopp }}">
                                            <td class="fw-medium">{{ trans.id }}</td>
                                            <td class="fw-medium">{{ trans.bokforingsdag.strftime('%Y-%m-%d') }}</td>
                                            <td class="text-center">
                                                {% for entry in trans.entries %}
                                                    <span class="badge bg-secondary text-white me-1 mb-1" style="font-size: 0.75em;" title="{{ entry.konto }} - {{ kontoplan.get(entry.konto, 'Okänt') }}">
                                                        {{ entry.konto }} - {{ kontoplan.get(entry.konto, entry.konto)|truncate(15, true, '') }}
                                                    </span>
                                                {% endfor %}
                                            </td>
                                            <td class="text-end fw-bold {% if trans.belopp < 0 %}text-danger{% else %}text-success{% endif %}">{{ "%.2f"|format(trans.belopp) }} kr</td>
                                            <td>{{ trans.referens }}</td>
                                        </tr>
                                    {% else %}
                                        <tr>
                                            <td colspan="5" class="text-center py-4 text-muted">Inga verifikationer hittades.</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include '_generic_entry_modal.html' %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const companyId = {{ company.id }};
    const kontoplan = {{ kontoplan|tojson }};
    const genericEntryModal = new bootstrap.Modal(document.getElementById('genericEntryModal'));
    const modalForm = document.getElementById('genericEntryForm');
    const entriesContainer = document.getElementById('entries-container');
    const tableBody = document.getElementById('verifikationer-table-body');
    const modalEntryId = document.getElementById('modal-entry-id');
    const modalEntryType = document.getElementById('modal-entry-type');
    const genericEntryModalLabel = document.getElementById('genericEntryModalLabel');
    const deleteEntryBtnModal = document.getElementById('delete-entry-btn-modal');


    // --- Table Sorting Logic ---
    const sortableHeaders = document.querySelectorAll('.sortable');
    let sortDirection = {};

    sortableHeaders.forEach(header => {
        header.addEventListener('click', () => {
            const sortKey = header.dataset.sort;
            const currentDir = sortDirection[sortKey] || 'asc';
            const newDir = currentDir === 'asc' ? 'desc' : 'asc';
            sortDirection[sortKey] = newDir;

            // Update icons
            sortableHeaders.forEach(h => {
                const icon = h.querySelector('i');
                if (icon) icon.className = 'bi bi-arrow-up-down ms-1';
            });
            const clickedIcon = header.querySelector('i');
            if (clickedIcon) {
                clickedIcon.className = newDir === 'asc' ? 'bi bi-arrow-up ms-1' : 'bi bi-arrow-down ms-1';
            }

            // Sort rows
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            rows.sort((a, b) => {
                let aVal, bVal;
                switch (sortKey) {
                    case 'id':
                        aVal = parseInt(a.dataset.id);
                        bVal = parseInt(b.dataset.id);
                        break;
                    case 'date':
                        aVal = a.dataset.date;
                        bVal = b.dataset.date;
                        break;
                    case 'ref':
                        aVal = a.dataset.ref.toLowerCase();
                        bVal = b.dataset.ref.toLowerCase();
                        break;
                    case 'amount':
                        aVal = parseFloat(a.dataset.amount);
                        bVal = parseFloat(b.dataset.amount);
                        break;
                    default:
                        return 0;
                }
                if (aVal < bVal) return newDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return newDir === 'asc' ? 1 : -1;
                return 0;
            });

            // Reappend rows
            rows.forEach(row => tableBody.appendChild(row));
        });
    });

    // Funktion för att skapa en ny rad för en bokföringspost
    function createEntryRow(entry = {}) {
        const row = document.createElement('div');
        row.className = 'row g-2 mb-2 entry-row';
        row.innerHTML = `
            <div class="col-md-5">
                <select class="form-select konto-select" name="konto">
                    <option value="">Välj konto...</option>
                    ${Object.entries(kontoplan).map(([nr, desc]) => `<option value="${nr}" ${entry.konto == nr ? 'selected' : ''}>${nr} - ${desc}</option>`).join('')}
                </select>
            </div>
            <div class="col-md-3">
                <input type="number" class="form-control debet-input" name="debet" placeholder="Debet" value="${entry.debet || ''}" step="0.01">
            </div>
            <div class="col-md-3">
                <input type="number" class="form-control kredit-input" name="kredit" placeholder="Kredit" value="${entry.kredit || ''}" step="0.01">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-sm btn-outline-danger remove-entry-row"><i class="bi bi-trash"></i></button>
            </div>
        `;
        entriesContainer.appendChild(row);
        new TomSelect(row.querySelector('.konto-select'), { create: false, sortField: { field: "text", direction: "asc" } });
    }

    // Funktion för att uppdatera totaler
    function updateTotals() {
        let totalDebet = 0;
        let totalKredit = 0;
        entriesContainer.querySelectorAll('.entry-row').forEach(row => {
            const debet = parseFloat(row.querySelector('.debet-input').value) || 0;
            const kredit = parseFloat(row.querySelector('.kredit-input').value) || 0;
            totalDebet += debet;
            totalKredit += kredit;
        });
        document.getElementById('total-debet').textContent = totalDebet.toFixed(2);
        document.getElementById('total-kredit').textContent = totalKredit.toFixed(2);
        const balance = totalDebet - totalKredit;
        const balanceEl = document.getElementById('balance');
        balanceEl.textContent = balance.toFixed(2);
        balanceEl.classList.toggle('text-danger', balance.toFixed(2) != '0.00');
        balanceEl.classList.toggle('text-success', balance.toFixed(2) == '0.00');
    }

    // Funktion för att fylla modalen med data
    async function populateGenericEntryModal(entryId, type) {
        modalForm.reset();
        entriesContainer.innerHTML = '';
        modalEntryId.value = entryId;
        modalEntryType.value = type;
        genericEntryModalLabel.textContent = `Redigera ${type === 'verifikation' ? 'verifikation' : type} ${entryId}`;

        let data;
        if (entryId) {
            const response = await fetch(`/api/verifikation/${entryId}`);
            data = await response.json();
            deleteEntryBtnModal.style.display = 'block';
        } else { // New entry
            data = {
                bokforingsdag: new Date().toISOString().slice(0, 10),
                referens: '',
                entries: []
            };
            deleteEntryBtnModal.style.display = 'none';
        }
        
        document.getElementById('modal-bokforingsdag').value = data.bokforingsdag;
        document.getElementById('modal-referens').value = data.referens;

        data.entries.forEach(entry => createEntryRow(entry));
        if (data.entries.length === 0) {
            createEntryRow();
            createEntryRow();
        }
        updateTotals();

        // Fyll i bankhändelse-info
        const bankEventInfo = document.getElementById('modal-bank-event-info');
        if (data.bank_event) {
            document.getElementById('bank-event-date').textContent = data.bank_event.date;
            document.getElementById('bank-event-ref').textContent = data.bank_event.ref;
            document.getElementById('bank-event-amount').textContent = data.bank_event.amount;
            bankEventInfo.style.display = 'block';
        } else {
            bankEventInfo.style.display = 'none';
        }

        // Fyll i bilagor
        const attachmentsList = document.getElementById('attachments-list');
        attachmentsList.innerHTML = '';
        if (data.attachments && data.attachments.length > 0) {
            data.attachments.forEach(att => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <a href="${att.url}" target="_blank">${att.filename}</a>
                    <button class="btn btn-sm btn-outline-danger" data-attachment-id="${att.id}">Frikoppla</button>
                `;
                attachmentsList.appendChild(li);
            });
        } else {
            attachmentsList.innerHTML = '<li class="list-group-item">Inga bilagor kopplade.</li>';
        }
    }

    // Event listeners
    document.getElementById('add-entry-row').addEventListener('click', () => createEntryRow());
    entriesContainer.addEventListener('click', e => {
        if (e.target.closest('.remove-entry-row')) {
            e.target.closest('.entry-row').remove();
            updateTotals();
        }
    });
    entriesContainer.addEventListener('input', e => {
        if (e.target.classList.contains('debet-input') || e.target.classList.contains('kredit-input')) {
            updateTotals();
        }
    });

    // Öppna modal för ny verifikation
    document.getElementById('new-ver-btn').addEventListener('click', () => {
        populateGenericEntryModal(null, 'verifikation'); // Pass null for new entry
        genericEntryModal.show();
    });

    // Öppna modal för att redigera befintlig verifikation
    tableBody.addEventListener('click', async function(e) {
        const row = e.target.closest('.ver-row');
        if (row) {
            const transId = row.dataset.transId;
            await populateGenericEntryModal(transId, 'verifikation');
            genericEntryModal.show();
        }
    });

    // Hantera borttagning från modalen
    deleteEntryBtnModal.addEventListener('click', async function() {
        const entryId = modalEntryId.value;
        if (!entryId || !confirm(`Är du säker på att du vill radera post ${entryId} permanent?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/verifikation/${entryId}`, { method: 'DELETE' });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Ett fel inträffade.');

            genericEntryModal.hide();
            alert('Posten har raderats.');
            location.reload();

        } catch (error) {
            alert(`Kunde inte radera posten: ${error.message}`);
        }
    });

    // Hantera formulär-submit (spara/skapa)
    modalForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const entryId = modalEntryId.value;
        const entryType = modalEntryType.value;
        const url = entryId ? `/api/verifikation/${entryId}` : `/api/company/${companyId}/verifikation`;
        const method = entryId ? 'PUT' : 'POST';

        const formData = new FormData(modalForm);
        const data = {
            bokforingsdag: formData.get('bokforingsdag'),
            referens: formData.get('referens'),
            entries: []
        };

        entriesContainer.querySelectorAll('.entry-row').forEach(row => {
            const konto = row.querySelector('.konto-select').value;
            const debet = parseFloat(row.querySelector('.debet-input').value) || 0;
            const kredit = parseFloat(row.querySelector('.kredit-input').value) || 0;
            if (konto && (debet > 0 || kredit > 0)) {
                data.entries.push({ konto, debet, kredit });
            }
        });

        const balance = parseFloat(document.getElementById('balance').textContent);
        if (balance.toFixed(2) != '0.00') {
            alert('Fel: Debet och Kredit måste vara i balans.');
            return;
        }
        if (data.entries.length === 0) {
            alert('Fel: Du måste ha minst en bokföringspost.');
            return;
        }

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Ett fel inträffade.');

            genericEntryModal.hide();
            alert('Verifikationen har sparats!');
            location.reload();

        } catch (error) {
            alert(`Kunde inte spara verifikationen: ${error.message}`);
        }
    });
});
</script>
{% endblock %}