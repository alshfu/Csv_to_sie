{% extends 'base.html' %}
{% block title %}Verifikationer - {{ company.name }}{% endblock %}

{% block content %}
    <div class="container-fluid py-4">
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="h2 mb-0 fw-bold text-primary">
                        <i class="bi bi-journal-plus me-2"></i>
                        Verifikationer: {{ company.name }}
                    </h2>
                    <button id="new-ver-btn" class="btn btn-primary btn-lg">
                        <i class="bi bi-plus-circle me-1"></i>
                        Skapa ny verifikation
                    </button>
                </div>
            </div>
        </div>

        <!-- Verifications Table Section -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0 align-middle sortable-table">
                                <thead class="table-dark">
                                <tr>
                                    <th scope="col" class="sortable" data-sort="id" style="width: 60px;">
                                        <span>Ver. ID</span>
                                        <i class="bi bi-arrow-up-down ms-1"></i>
                                    </th>
                                    <th scope="col" class="sortable" data-sort="date" style="width: 10ch;">
                                        <span>Datum</span>
                                        <i class="bi bi-arrow-up-down ms-1"></i>
                                    </th>
                                    <th scope="col" class="text-center" style="width: 200px;">Konton</th>
                                    <th scope="col" class="text-end sortable" data-sort="amount" style="width: 120px;">
                                        <span>Belopp</span>
                  <i class="bi bi-arrow-up-down ms-1"></i>
                                    </th>
                                    <th scope="col" class="sortable" data-sort="ref" style="width: 200px;">
                                        <span>Referens</span>
                                        <i class="bi bi-arrow-up-down ms-1"></i>
                                    </th>
                                </tr>
                                </thead>
                                <tbody id="verifikationer-table-body">
                                {% for trans in transactions %}
                                    <tr id="ver-row-{{ trans.id }}" class="ver-row" data-trans-id="{{ trans.id }}"
                                        style="cursor: pointer;" data-id="{{ trans.id }}"
                                        data-date="{{ trans.bokforingsdag.strftime('%Y-%m-%d') }}"
                                        data-ref="{{ trans.referens }}" data-amount="{{ trans.belopp }}">
                                        <td class="fw-medium">{{ trans.id }}</td>
                                        <td class="fw-medium">{{ trans.bokforingsdag.strftime('%Y-%m-%d') }}</td>
                                        <td class="text-center">
                                            {% for entry in trans.entries %}
                                                <span class="badge bg-secondary text-white me-1 mb-1"
                                                      style="font-size: 0.75em;"
                                                      title="{{ entry.konto }} - {{ kontoplan.get(entry.konto, 'Okänt') }}">
                                                        {{ entry.konto }} - {{ kontoplan.get(entry.konto, entry.konto)|truncate(15, true, '') }}
                                                    </span>
                                            {% endfor %}
                                        </td>
                                        <td class="text-end fw-bold {% if trans.belopp < 0 %}text-danger{% else %}text-success{% endif %}">{{ "%.2f"|format(trans.belopp) }}
                                            kr
                                        </td>
                                        <td>{{ trans.referens }}</td>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center py-4 text-muted">Inga verifikationer
                                            hittades.
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include '_generic_entry_modal.html' %}
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='js/genericEntryModal.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const config = {
                companyId: {{ company.id }},
                kontoplan: {{ kontoplan|tojson }},
                fetchUrls: {
                    get: '/api/verifikation/{id}',
                    post: '/api/company/{{ company.id }}/verifikation',
                    put: '/api/verifikation/{id}',
                    delete: '/api/verifikation/{id}'
                }
            };

            const modalManager = new GenericEntryModal(config);

            // Öppna modal för ny verifikation
            document.getElementById('new-ver-btn').addEventListener('click', () => {
                modalManager.openModal(null, 'verifikation');
            });

            // Öppna modal för att redigera befintlig verifikation
            document.getElementById('verifikationer-table-body').addEventListener('click', function (e) {
                const row = e.target.closest('.ver-row');
                if (row) {
                    const transId = row.dataset.transId;
                    modalManager.openModal(transId, 'verifikation');
                }
            });

            // --- Table Sorting Logic (omitted for brevity, can be a separate utility) ---
        });
    </script>
{% endblock %}
