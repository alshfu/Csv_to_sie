{% extends "base.html" %}
{% block title %}Momsrapport - {{ company.name }}{% endblock %}
{% block page_title %}Momsrapport{% endblock %}

{% block content %}
    <!-- Filter Card -->
    <div class="card">
        <div class="card-header">
            Filtrera rapport
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('main.momsrapport_page', company_id=company.id) }}" id="moms-form">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="year" class="form-label">År:</label>
                        <select class="form-select" id="year" name="year">
                            {% for y in available_years %}
                                <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="quarter" class="form-label">Kvartal:</label>
                        <select class="form-select" id="quarter" name="quarter">
                            <option value="">Alla</option>
                            <option value="1" {% if selected_quarter == '1' %}selected{% endif %}>K1 (Jan-Mar)</option>
                            <option value="2" {% if selected_quarter == '2' %}selected{% endif %}>K2 (Apr-Jun)</option>
                            <option value="3" {% if selected_quarter == '3' %}selected{% endif %}>K3 (Jul-Sep)</option>
                            <option value="4" {% if selected_quarter == '4' %}selected{% endif %}>K4 (Okt-Dec)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="month" class="form-label">Månad:</label>
                        <select class="form-select" id="month" name="month">
                            <option value="">Alla</option>
                            {% for i in range(1, 13) %}
                                <option value="{{ i }}" {% if i|string == selected_month %}selected{% endif %}>{{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary w-100">Visa rapport</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Momsrapport Table -->
    {% if moms_data %}
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                Momsrapport för {{ report_period }}
                <a href="{{ url_for('main.export_moms_xml', company_id=company.id, year=selected_year, quarter=selected_quarter, month=selected_month) }}" class="btn btn-success">
                    <i class="bi bi-download me-2"></i>Exportera XML
                </a>
            </div>
            <div class="card-body">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Momsbeskrivning</th>
                            <th class="text-end">Utgående moms (SEK)</th>
                            <th class="text-end">Ingående moms (SEK)</th>
                        </tr>
                    </thead>
                    <tbody id="moms-table-body">
                        {% for konto_nr, data in moms_data.items() %}
                            {% if data.utgaende > 0 or data.ingende > 0 %}
                            <tr class="moms-row" data-konto="{{ konto_nr }}" style="cursor: pointer;" title="Klicka för att se verifikationer">
                                <td>{{ data.description }}</td>
                                <td class="text-end">{{ "%.2f"|format(data.utgaende) }}</td>
                                <td class="text-end">{{ "%.2f"|format(data.ingende) }}</td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-group-divider">
                        <tr>
                            <th>Totaler</th>
                            <th class="text-end">{{ "%.2f"|format(total_utgaende) }}</th>
                            <th class="text-end">{{ "%.2f"|format(total_ingende) }}</th>
                        </tr>
                        <tr>
                            <th colspan="2">Moms att betala / få tillbaka</th>
                            <th class="text-end">{{ "%.2f"|format(total_utgaende - total_ingende) }}</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    {% else %}
        <div class="alert alert-info" role="alert">
            Ingen momsdata tillgänglig för den valda perioden.
        </div>
    {% endif %}

    <!-- Modal for Verifikationer List -->
    <div class="modal fade" id="verifikationerListModal" tabindex="-1" aria-labelledby="verifikationerListModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="verifikationerListModalLabel">Underliggande Verifikationer</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Datum</th>
                  <th>Referens</th>
                  <th class="text-end">Belopp (SEK)</th>
                </tr>
              </thead>
              <tbody id="modal-verifikationer-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

{% include '_generic_entry_modal.html' %}

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/genericEntryModal.js') }}" defer></script>
<script defer>
document.addEventListener('DOMContentLoaded', function () {
    const companyId = {{ company.id }};
    const kontoplan = {{ KONTOPLAN|tojson }};

    const verifikationerListModal = new bootstrap.Modal(document.getElementById('verifikationerListModal'));
    const modalVerifikationerBody = document.getElementById('modal-verifikationer-body');
    const verifikationerListModalLabel = document.getElementById('verifikationerListModalLabel');

    const modalManager = new GenericEntryModal({
        companyId: companyId,
        kontoplan: kontoplan,
        fetchUrls: {
            get: '/api/verifikation/{id}',
            post: `/api/company/${companyId}/verifikation`,
            put: '/api/verifikation/{id}',
            delete: '/api/verifikation/{id}'
        }
    });

    document.getElementById('moms-table-body').addEventListener('click', function (event) {
        const row = event.target.closest('.moms-row');
        if (!row) return;

        const konto = row.dataset.konto;
        const description = row.cells[0].textContent;
        const year = document.getElementById('year').value;
        const quarter = document.getElementById('quarter').value;
        const month = document.getElementById('month').value;

        if (!konto) return;

        verifikationerListModalLabel.textContent = `Verifikationer för ${description}`;
        const url = new URL(`{{ url_for('api.get_moms_verifikationer', company_id=company.id) }}`, window.location.origin);
        url.searchParams.append('konto', konto);
        url.searchParams.append('year', year);
        if (quarter) url.searchParams.append('quarter', quarter);
        if (month) url.searchParams.append('month', month);

        fetch(url)
            .then(response => response.json())
            .then(data => {
                modalVerifikationerBody.innerHTML = '';
                if (data.length === 0) {
                    modalVerifikationerBody.innerHTML = '<tr><td colspan="3" class="text-center">Inga verifikationer hittades.</td></tr>';
                } else {
                    data.forEach(ver => {
                        const tr = document.createElement('tr');
                        tr.className = 'ver-detail-row';
                        tr.style.cursor = 'pointer';
                        tr.dataset.verId = ver.id;
                        tr.innerHTML = `
                            <td>${ver.bokforingsdag}</td>
                            <td>${ver.referens}</td>
                            <td class="text-end">${parseFloat(ver.belopp).toLocaleString('sv-SE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        `;
                        modalVerifikationerBody.appendChild(tr);
                    });
                }
                verifikationerListModal.show();
            })
            .catch(error => showToast('Kunde inte hämta verifikationer.', 'danger'));
    });

    modalVerifikationerBody.addEventListener('click', function(e) {
        const row = e.target.closest('.ver-detail-row');
        if (row) {
            const verId = row.dataset.verId;
            verifikationerListModal.hide();
            modalManager.openModal(verId, 'verifikation');
        }
    });
    
    const genericModalElement = document.getElementById('genericEntryModal');
    genericModalElement.addEventListener('hidden.bs.modal', function () {
        // Om vi kom från listan, visa den igen.
        if (document.body.classList.contains('modal-open')) {
             // Already another modal open, do nothing
        } else {
            verifikationerListModal.show();
        }
    });
});
</script>
{% endblock %}
