{% extends 'base.html' %}
{% block title %}Bokföring - {{ company.name }}{% endblock %}

{% block content %}
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm mb-3">&larr; Tillbaka till
        Företagslistan</a>
    <h2>Bokföring: {{ company.name }}</h2>

    <a href="{{ url_for('verifikationer_page', company_id=company.id) }}" class="btn btn-info btn-sm mb-3">
        Visa bokförda verifikationer (Arkiv) &rarr;
    </a>

    <div class="card bg-light my-4">
        <div class="card-body">
            <h5 class="card-title">Ladda upp ny CSV</h5>
            <form action="{{ url_for('upload_csv', company_id=company.id) }}" method="POST"
                  enctype="multipart/form-data">
                <div class="input-group">
                    <input type="file" class="form-control" name="csv_file" accept=".csv" required>
                    <button class="btn btn-primary" type="submit">Ladda upp</button>
                </div>
            </form>
        </div>
    </div>

    <h3>Obearbetade transaktioner</h3>

    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
            <tr>
                <th data-sort-index="0" data-sort-type="date" style="cursor: pointer;">Datum</th>
                <th data-sort-index="1" data-sort-type="text" style="cursor: pointer;">Referens</th>
                <th data-sort-index="2" data-sort-type="number" style="cursor: pointer;">Belopp</th>
                <th data-sort-index="3" data-sort-type="text" style="cursor: pointer;">Konton</th>
                <th data-sort-index="4" data-sort-type="text" style="cursor: pointer;">Status</th>
                <th>Bilaga</th>
            </tr>
            </thead>
            <tbody id="transactions-table-body">
            {% for trans in transactions %}
                <tr id="trans-row-{{ trans.id }}"
                    class="transaction-row"
                    style="cursor: pointer;"
                    data-bs-toggle="modal"
                    data-bs-target="#bokforingModal"
                    data-trans-id="{{ trans.id }}"
                    data-referens="{{ trans.referens }}"
                    data-amount="{{ '%.2f'|format(trans.belopp) }}"
                    data-date="{{ trans.bokforingsdag.strftime('%Y-%m-%d') }}">

                    <td>{{ trans.bokforingsdag.strftime('%Y-%m-%d') }}</td>
                    <td>{{ trans.referens }}</td>
                    <td>{{ "%.2f"|format(trans.belopp) }}</td>
                    <td>
                        {% for entry in trans.entries %}
                            {% if entry.konto != '1930' %}
                                <span class="badge bg-light text-dark" style="border: 1px solid #ccc;"
                                      title="{{ entry.konto }}">
                                    {{ kontoplan.get(entry.konto, entry.konto) }}
                                </span>
                            {% endif %}
                        {% endfor %}
                    </td>
                    <td>
                        <span class="badge bg-warning text-dark">{{ trans.status }}</span>
                    </td>
                    <td>
                        {% if trans.attachments|length > 0 %}
                            <span class="badge bg-secondary">{{ trans.attachments|length }} bilaga(or)</span>
                        {% else %}
                            <span class="badge bg-light text-dark">Inga bilagor</span>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <hr>

    <form action="{{ url_for('generate_sie', company_id=company.id) }}" method="POST" class="mt-3">
        <button type="submit" class="btn btn-success">Generera SIE-fil</button>
    </form>

    <div class="modal fade" id="bokforingModal" tabindex="-1" aria-labelledby="bokforingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bokforingModalLabel">Bokför transaktion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div id="modal-alert" class="alert alert-danger" style="display: none;" role="alert"></div>

                    <p><strong>Datum:</strong> <span id="modal-date"></span></p>
                    <p><strong>Referens:</strong> <span id="modal-referens"></span></p>
                    <p><strong>Bankbelopp:</strong> <span id="modal-amount" class="fw-bold"></span></p>

                    <hr>

                    <h6>Bilagor</h6>
                    <div class="row">
                        <div class="col-md-5">
                            <ul id="bilaga-list" class="list-group list-group-flush mb-3"
                                style="max-height: 350px; overflow-y: auto;">
                                <li class="list-group-item" id="bilaga-loading-placeholder" style="display: none;">
                                    Laddar...
                                </li>
                            </ul>
                            <form id="bilaga-form" class="mb-3">
                                <div class="input-group">
                                    <input type="file" class="form-control" name="bilaga_file" id="bilaga_file_input"
                                           required>
                                    <button class="btn btn-outline-secondary" type="submit" id="bilaga-upload-btn">Ladda
                                        upp
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-7">
                            <embed id="bilaga-preview" src="" type="application/pdf" width="100%" height="400px"
                                   style="border: 1px solid #ccc; display: none;">
                            <div id="bilaga-preview-placeholder" class="text-center text-muted"
                                 style="border: 1px dashed #ccc; height: 400px; display: flex; align-items: center; justify-content: center;">
                                Klicka på en fil i listan för att förhandsgranska
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="mb-3">
                        <label class="form-label">Beräkna moms (klicka i en summa-ruta först):</label>
                        <div class="btn-group" role="group" id="moms-btn-group">
                            <button type="button" class="btn btn-outline-info btn-sm moms-btn" data-rate="25" disabled>
                                Moms 25%
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm moms-btn" data-rate="12" disabled>
                                Moms 12%
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm moms-btn" data-rate="6" disabled>
                                Moms 6%
                            </button>
                        </div>
                    </div>

                    <form id="bokforing-form">
                        <input type="hidden" id="modal-trans-id">
                        <table class="table table-sm">
                            <thead>
                            <tr>
                                <th>Konto</th>
                                <th>Debet</th>
                                <th>Kredit</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody id="entries-container">
                            <template id="entry-row-template">
                                <tr>
                                    <td>
                                        <input type="text" class="konto-input" placeholder="Välj konto...">
                                    </td>
                                    <td><input type="number" step="0.01"
                                               class="form-control form-control-sm debet-input" placeholder="0.00"></td>
                                    <td><input type="number" step="0.01"
                                               class="form-control form-control-sm kredit-input" placeholder="0.00">
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-danger btn-sm remove-row-btn">X</button>
                                    </td>
                                </tr>
                            </template>
                            </tbody>
                            <tfoot>
                            <tr>
                                <td><strong>Summa:</strong></td>
                                <td><strong id="total-debet">0.00</strong></td>
                                <td><strong id="total-kredit">0.00</strong></td>
                                <td></td>
                            </tr>
                            <tr>
                                <td colspan="2"><strong>Differens:</strong></td>
                                <td colspan="2"><strong id="total-diff" class="text-danger">0.00</strong></td>
                            </tr>
                            </tfoot>
                        </table>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="add-row-btn">Lägg till rad
                        </button>
                    </form>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                    <button type="button" class="btn btn-primary" id="save-entries-btn">Spara</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}


{% block scripts %}
    <script>
        const KONTOPLAN = {{ kontoplan|tojson }};
    </script>
    <script src="{{ url_for('static', filename='js/mainTable.js') }}"></script>
    <script src="{{ url_for('static', filename='js/kontoAutocomplete.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modalHandler.js') }}"></script>
{% endblock %}