# Техническая документация проекта "Csv_to_sie"

## 1. Обзор проекта

**Csv_to_sie** — это веб-приложение, разработанное на Flask, для ведения бухгалтерского учёта. Основная цель приложения — упростить процесс обработки и учёта финансовых документов (квитанций, счетов-фактур) и банковских выписок (CSV), их загрузки, анализа и последующей проводки в соответствии с планом счетов.

Ключевые возможности:
- Управление несколькими компаниями.
- Загрузка и хранение финансовых документов (PDF, JPG, PNG).
- **Обработка CSV-файлов с банковскими транзакциями.**
- Интерактивный интерфейс для просмотра, редактирования метаданных и проводки документов.
- Встроенный просмотрщик PDF с функциями навигации и масштабирования на базе **PDF.js**.
- Автоматическое предложение счетов на основе правил ассоциации.
- Преобразование данных в формат SIE (стандартный формат для импорта/экспорта бухгалтерских данных в Швеции).

## 2. Технический стек

- **Бэкенд:**
  - **Язык:** Python 3
  - **Фреймворк:** Flask
  - **База данных:** Flask-SQLAlchemy (предположительно, на основе структуры проекта)
  - **Обработка данных:** Pandas

- **Фронтенд:**
  - **HTML/CSS:** Шаблонизатор Jinja2, фреймворк Bootstrap 5.
  - **JavaScript:**
    - Нативный JavaScript (ES6 Modules).
    - **PDF.js** (локальная версия `5.4.394-dist`) для рендеринга PDF.
    - **Tom-select** для автодополнения в полях выбора счетов.

- **Окружение:**
  - **Виртуальное окружение:** `venv`
  - **Система контроля версий:** Git

## 3. Структура проекта

```
/
├── bokforing_app/            # Основной пакет приложения
│   ├── api/                  # Модули для API эндпоинтов
│   ├── services/             # Бизнес-логика (работа с PDF, CSV, проводки)
│   ├── static/               # Статические файлы
│   │   ├── css/
│   │   ├── js/
│   │   │   ├── bilagaPage.js         # Логика страницы "Bilagor"
│   │   │   ├── kontoAutocomplete.js  # Логика автодополнения счетов
│   │   │   └── pdfjs-5.4.394-dist/ # Локальная библиотека PDF.js
│   │   └── uploads/            # Загруженные пользователем файлы
│   ├── templates/            # HTML-шаблоны (Jinja2)
│   │   ├── bilagor.html        # Страница для работы с документами
│   │   └── base.html           # Базовый шаблон
│   ├── __init__.py           # Инициализация Flask-приложения
│   └── models.py             # Модели базы данных (SQLAlchemy)
│
├── instance/                 # Файлы инстанса (например, SQLite БД)
├── venv/                     # Виртуальное окружение
└── README.md                 # Эта документация
```

## 4. Установка и запуск

1.  **Клонировать репозиторий:**
    ```bash
    git clone <repository_url>
    cd Csv_to_sie
    ```

2.  **Создать и активировать виртуальное окружение:**
    ```bash
    python3 -m venv venv
    source venv/bin/activate  # Для macOS/Linux
    # или
    venv\Scripts\activate     # Для Windows
    ```

3.  **Установить зависимости:**
    (Предполагается наличие файла `requirements.txt`)
    ```bash
    pip install -r requirements.txt
    ```
    *Если файла нет, основные зависимости: `Flask`, `Flask-SQLAlchemy`, `Flask-Migrate`, `pandas`.*

4.  **Инициализировать и применить миграции базы данных:**
    ```bash
    flask db init
    flask db migrate -m "Initial migration."
    flask db upgrade
    ```

5.  **Запустить приложение:**
    ```bash
    flask run
    ```
    Приложение будет доступно по адресу `http://127.0.0.1:5000`.

## 5. Обработка CSV-файлов

Система позволяет загружать CSV-файлы с банковскими транзакциями для их автоматической обработки и создания бухгалтерских записей.

- **Эндпоинт:** `POST /api/company/<int:company_id>/upload_csv`
- **Сервис:** `booking_service.process_csv_upload`

### Требования к формату CSV:
- **Кодировка:** `latin-1`
- **Разделитель полей:** точка с запятой (`;`)
- **Десятичный разделитель:** запятая (`,`)
- **Заголовки:** Ожидается, что данные начинаются со второй строки (`header=1`).
- **Ключевые колонки:** `Bokföringsdag`, `Insättning/Uttag`, `Referens`.

### Логика обработки:
1.  Файл читается с помощью библиотеки **Pandas**.
2.  Для каждой строки в файле создается запись `BankTransaction`.
3.  На основе суммы (`Insättning/Uttag`) и текста справки (`Referens`) определяется контр-счет с помощью функции `get_contra_account`.
4.  Автоматически создаются две проводки (`BookkeepingEntry`): одна для банковского счета (`1930`), другая для контр-счета, обеспечивая двойную запись.

## 6. Ключевые API эндпоинты

Все эндпоинты находятся в пакете `bokforing_app/api/`.

- `POST /api/company/<int:company_id>/multi_upload_bilagor`
  - **Назначение:** Массовая загрузка файлов (документов).
  - **Тело запроса:** `FormData` с файлами в поле `files`.
  - **Ответ:** JSON-массив с информацией о загруженных файлах.

- `POST /api/bilaga/<int:bilaga_id>/metadata`
  - **Назначение:** Сохранение обновлённых метаданных документа.
  - **Тело запроса:** JSON с полями документа (например, `fakturadatum`, `saljare_namn` и т.д.).
  - **Ответ:** JSON с сообщением об успехе или ошибке.

- `POST /api/bilaga/<int:bilaga_id>/bokfor`
  - **Назначение:** Проводка документа с указанными бухгалтерскими записями.
  - **Тело запроса:** JSON с массивом `entries`, где каждый объект содержит `konto`, `debet`, `kredit`.
  - **Ответ:** JSON с сообщением об успехе или ошибке.

- `DELETE /api/bilaga/<int:bilaga_id>`
  - **Назначение:** Удаление документа.
  - **Ответ:** JSON с сообщением об успехе.
```